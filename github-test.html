<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Integration Test - BMC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>GitHub Integration Test</h1>
        <p>Test the GitHub database and photo upload functionality</p>
        
        <!-- Status Display -->
        <div id="status" class="alert alert-info">
            <h5>Status:</h5>
            <div id="status-content">Initializing...</div>
        </div>
        
        <!-- Test Results -->
        <div id="test-results"></div>
        
        <!-- Actions -->
        <div class="row mt-4">
            <div class="col-md-6">
                <button class="btn btn-primary" onclick="testDatabaseLoad()">
                    <i class="fas fa-download"></i> Test Load Data
                </button>
                <button class="btn btn-success ms-2" onclick="testDatabaseSave()">
                    <i class="fas fa-save"></i> Test Save Data
                </button>
            </div>
            <div class="col-md-6">
                <input type="file" id="test-file" accept="image/*" class="form-control mb-2">
                <button class="btn btn-warning" onclick="testPhotoUpload()">
                    <i class="fas fa-upload"></i> Test Photo Upload
                </button>
            </div>
        </div>
        
        <!-- Logs -->
        <div class="mt-4">
            <h5>Logs:</h5>
            <div id="logs" style="background: #f8f9fa; padding: 10px; max-height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-line;"></div>
        </div>
    </div>

    <script src="assets/js/github-database.js"></script>
    <script>
        const logs = document.getElementById('logs');
        const status = document.getElementById('status-content');
        
        function addLog(message) {
            console.log(message);
            logs.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logs.scrollTop = logs.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            status.innerHTML = message;
            const statusEl = document.getElementById('status');
            statusEl.className = `alert alert-${type}`;
        }
        
        // Initialize
        window.addEventListener('load', () => {
            const githubToken = localStorage.getItem('bmc-github-token');
            
            if (githubToken) {
                addLog('GitHub token found in localStorage');
                if (window.configureAPIs) {
                    window.configureAPIs(githubToken);
                    addLog('GitHub API configured');
                }
                
                if (window.gitHubDbManager) {
                    addLog('GitHub Database Manager available');
                    updateStatus('✅ GitHub configured and ready', 'success');
                } else {
                    addLog('GitHub Database Manager not available');
                    updateStatus('❌ GitHub Database Manager not found', 'danger');
                }
            } else {
                addLog('No GitHub token found');
                updateStatus('⚠️ GitHub token not configured. Visit setup-apis.html', 'warning');
            }
        });
        
        async function testDatabaseLoad() {
            addLog('Testing database load...');
            updateStatus('Loading data from GitHub...', 'info');
            
            try {
                const dbMgr = window.gitHubDbManager || window.dbManager;
                if (!dbMgr) {
                    throw new Error('Database manager not available');
                }
                
                const trips = await dbMgr.getTrips();
                addLog(`Successfully loaded ${trips.length} trips`);
                updateStatus(`✅ Loaded ${trips.length} trips from GitHub`, 'success');
                
                // Display first trip as example
                if (trips.length > 0) {
                    addLog('First trip: ' + JSON.stringify(trips[0], null, 2));
                }
                
            } catch (error) {
                addLog('Error loading data: ' + error.message);
                updateStatus('❌ Failed to load data: ' + error.message, 'danger');
            }
        }
        
        async function testDatabaseSave() {
            addLog('Testing database save...');
            updateStatus('Saving test trip to GitHub...', 'info');
            
            try {
                const dbMgr = window.gitHubDbManager || window.dbManager;
                if (!dbMgr) {
                    throw new Error('Database manager not available');
                }
                
                const testTrip = {
                    location: 'Test Peak',
                    date: new Date().toISOString().split('T')[0],
                    members: ['Test User'],
                    description: 'This is a test trip created by the integration test',
                    distance: '5 miles',
                    elevation: '2000 ft',
                    duration: '4 hours',
                    photos: []
                };
                
                const savedTrip = await dbMgr.addTrip(testTrip);
                addLog('Successfully saved test trip: ' + JSON.stringify(savedTrip, null, 2));
                updateStatus('✅ Test trip saved to GitHub', 'success');
                
            } catch (error) {
                addLog('Error saving test trip: ' + error.message);
                updateStatus('❌ Failed to save trip: ' + error.message, 'danger');
            }
        }
        
        async function testPhotoUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                addLog('No file selected');
                updateStatus('⚠️ Please select an image file first', 'warning');
                return;
            }
            
            addLog('Testing photo upload...');
            updateStatus('Uploading photo to GitHub...', 'info');
            
            try {
                const dbMgr = window.gitHubDbManager || window.dbManager;
                if (!dbMgr) {
                    throw new Error('Database manager not available');
                }
                
                addLog(`Uploading file: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
                
                const imageUrl = await dbMgr.uploadPhoto(file, 'test-upload');
                
                if (imageUrl) {
                    addLog('Photo uploaded successfully: ' + imageUrl);
                    updateStatus('✅ Photo uploaded to GitHub', 'success');
                    
                    // Show preview
                    const preview = document.createElement('div');
                    preview.innerHTML = `
                        <div class="mt-3">
                            <h6>Uploaded Photo Preview:</h6>
                            <img src="${imageUrl}" class="img-thumbnail" style="max-width: 300px;">
                            <br><small class="text-muted">URL: ${imageUrl}</small>
                        </div>
                    `;
                    document.getElementById('test-results').appendChild(preview);
                } else {
                    throw new Error('Photo upload returned null URL');
                }
                
            } catch (error) {
                addLog('Error uploading photo: ' + error.message);
                updateStatus('❌ Failed to upload photo: ' + error.message, 'danger');
            }
        }
    </script>
</body>
</html>