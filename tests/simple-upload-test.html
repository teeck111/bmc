<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Upload Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>üß™ Simple Upload Test</h1>
        <p class="lead">This test replicates the exact same upload logic as add-trip.js</p>
        
        <div class="card">
            <div class="card-body">
                <input type="file" id="photoFiles" accept="image/*" multiple class="form-control mb-3">
                <button onclick="testUpload()" class="btn btn-primary">Upload Using Add-Trip Logic</button>
                
                <div id="results" class="mt-3"></div>
                
                <div id="console-output" class="mt-4 p-3 bg-dark text-light" style="height: 400px; overflow-y: auto; font-family: monospace;"></div>
            </div>
        </div>
    </div>

    <script src="../assets/js/firebase-config.js?v=1758673793"></script>
    <script>
        // Capture console output
        const consoleDiv = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToConsole(message, isError = false) {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.color = isError ? '#ff6b6b' : '#4ecdc4';
            div.textContent = `[${time}] ${message}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), true);
        };
        
        // Exact same upload logic as add-trip.js
        async function testUpload() {
            const fileInput = document.getElementById('photoFiles');
            const resultsDiv = document.getElementById('results');
            const files = fileInput.files;
            
            if (files.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">Please select files first</div>';
                return;
            }
            
            console.log('üöÄ Starting upload test...');
            resultsDiv.innerHTML = '<div class="alert alert-info">Testing upload...</div>';
            
            // Check if Firebase Storage is available (same as add-trip.js)
            const dbMgr = window.dbManager || dbManager;
            console.log('dbManager available:', !!dbMgr);
            console.log('window.storage available:', !!window.storage);
            console.log('firebase.storage available:', !!(typeof firebase !== 'undefined' && firebase.storage));
            
            if (!dbMgr) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">Database manager not available. Please refresh the page.</div>';
                return;
            }
            
            // Try to access Firebase Storage directly (same as add-trip.js)
            try {
                const storage = firebase.storage();
                console.log('Firebase Storage initialized successfully');
            } catch (error) {
                console.error('Firebase Storage initialization failed:', error);
                resultsDiv.innerHTML = `<div class="alert alert-danger">Firebase Storage not available. Error: ${error.message}</div>`;
                return;
            }
            
            // Validate files (same as add-trip.js)
            const validFiles = [];
            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    console.log(`"${file.name}" is not an image file. Only image files are allowed.`);
                    continue;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    console.log(`"${file.name}" is too large (${(file.size/1024/1024).toFixed(1)}MB). Maximum size is 10MB.`);
                    continue;
                }
                
                validFiles.push(file);
            }
            
            if (validFiles.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">No valid files to upload</div>';
                return;
            }
            
            try {
                // Generate temporary trip ID for upload organization (same as add-trip.js)
                const tempTripId = `temp-${Date.now()}`;
                console.log('Starting photo upload with tempTripId:', tempTripId);
                console.log('Valid files to upload:', validFiles.map(f => f.name));
                
                // Upload photos to Firebase Storage (same as add-trip.js)
                const uploadedUrls = await dbMgr.uploadPhotos(validFiles, tempTripId, 
                    (completed, total, success) => {
                        console.log(`Upload progress: ${completed}/${total}, success: ${success}`);
                        resultsDiv.innerHTML = `<div class="alert alert-info">Uploading... ${completed}/${total} completed</div>`;
                    }
                );
                
                console.log('Upload completed. URLs:', uploadedUrls);
                
                if (uploadedUrls.length > 0) {
                    let html = `<div class="alert alert-success">‚úÖ Successfully uploaded ${uploadedUrls.length}/${validFiles.length} photos!</div>`;
                    uploadedUrls.forEach((url, index) => {
                        html += `<div class="mb-2"><img src="${url}" alt="Uploaded ${index + 1}" style="max-width: 200px; max-height: 150px;" class="img-thumbnail"></div>`;
                    });
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<div class="alert alert-danger">‚ùå No photos were uploaded successfully</div>';
                }
                
                if (uploadedUrls.length < validFiles.length) {
                    resultsDiv.innerHTML += `<div class="alert alert-warning">‚ö†Ô∏è Only ${uploadedUrls.length} of ${validFiles.length} photos uploaded</div>`;
                }
                
            } catch (error) {
                console.error('Photo upload error:', error);
                resultsDiv.innerHTML = `<div class="alert alert-danger">‚ùå Upload failed: ${error.message}</div>`;
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            console.log('üß™ Simple Upload Test loaded');
            console.log('Environment:', {
                dbManager: !!window.dbManager,
                firebase: !!window.firebase,
                storage: !!(window.firebase && window.firebase.storage)
            });
        });
    </script>
</body>
</html>