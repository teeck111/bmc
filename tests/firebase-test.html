<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>üî• Firebase Connection Test</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>Firestore Test</h3>
                <button onclick="testFirestore()" class="btn btn-primary">Test Database</button>
                <div id="firestore-result" class="mt-2"></div>
            </div>
            
            <div class="col-md-6">
                <h3>Storage Test</h3>
                <input type="file" id="test-file" accept="image/*" class="form-control mb-2">
                <button onclick="testStorage()" class="btn btn-success">Test Photo Upload</button>
                <div id="storage-result" class="mt-2"></div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h3>Console Output</h3>
                <div id="console-output" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace;"></div>
            </div>
        </div>
    </div>

    <script src="../assets/js/firebase-config.js"></script>
    <script>
        // Capture console output
        const consoleDiv = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToConsole(message, isError = false) {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.color = isError ? '#ff6b6b' : '#4ecdc4';
            div.textContent = `[${time}] ${message}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), true);
        };
        
        // Test functions
        async function testFirestore() {
            const resultDiv = document.getElementById('firestore-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing...';
            
            try {
                console.log('Testing Firestore connection...');
                
                if (!window.dbManager) {
                    throw new Error('Database manager not available');
                }
                
                console.log('Loading trips from database...');
                const trips = await window.dbManager.getTrips();
                
                console.log(`Loaded ${trips.length} trips successfully`);
                resultDiv.innerHTML = `<div class="alert alert-success">‚úÖ Success! Loaded ${trips.length} trips</div>`;
                
            } catch (error) {
                console.error('Firestore test failed:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testStorage() {
            const resultDiv = document.getElementById('storage-result');
            const fileInput = document.getElementById('test-file');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Please select an image file first</div>';
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Uploading...';
            
            try {
                console.log(`Testing photo upload: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
                
                if (!window.dbManager) {
                    throw new Error('Database manager not available');
                }
                
                const downloadURL = await window.dbManager.uploadPhoto(file, 'test-trip');
                
                if (downloadURL) {
                    console.log('Photo upload successful:', downloadURL);
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">‚úÖ Upload Success!</div>
                        <img src="${downloadURL}" alt="Uploaded" style="max-width: 200px; max-height: 150px;" class="img-thumbnail mt-2">
                        <small class="d-block mt-2">URL: ${downloadURL}</small>
                    `;
                } else {
                    throw new Error('Upload returned null URL');
                }
                
            } catch (error) {
                console.error('Storage test failed:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Auto-test on load
        window.addEventListener('load', () => {
            console.log('üöÄ Firebase Test Page Loaded');
            console.log('Firebase config:', window.dbManager ? 'Available' : 'Not Available');
            console.log('UseFirebase:', window.dbManager ? window.dbManager.useFirebase : 'N/A');
            
            // Auto-test Firestore
            setTimeout(testFirestore, 1000);
        });
    </script>
</body>
</html>