<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netlify Debug - BMC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <h1>üîç Netlify Deployment Debug</h1>
        <p class="lead">Test your Netlify functions and environment setup</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>üìç Environment Detection</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Hostname:</strong> <span id="hostname"></span></p>
                        <p><strong>API Base URL:</strong> <span id="baseUrl"></span></p>
                        <p><strong>Environment:</strong> <span id="environment"></span></p>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>üîê Password Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Test Club Password:</label>
                            <input type="password" id="testPassword" class="form-control" placeholder="BigMountain2024">
                        </div>
                        <button class="btn btn-primary" onclick="testPassword()">Test Password</button>
                        <div id="passwordResult" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>üéØ Function Tests</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success mb-2 w-100" onclick="testGetTrips()">Test get-trips</button>
                        <button class="btn btn-warning mb-2 w-100" onclick="testAddTrip()">Test add-trip</button>
                        <button class="btn btn-info mb-2 w-100" onclick="testUploadPhoto()">Test upload-photos</button>
                        <div id="functionResults" class="mt-3"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>üìù Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleOutput" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                            Ready to test...<br>
                        </div>
                        <button class="btn btn-secondary btn-sm mt-2" onclick="clearConsole()">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/netlify-database.js"></script>
    <script>
        // Enhanced console logging
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('ERROR: ' + args.join(' '), 'error');
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('hostname').textContent = window.location.hostname;
            
            if (window.dbManager) {
                document.getElementById('baseUrl').textContent = window.dbManager.baseUrl;
                document.getElementById('environment').textContent = 
                    window.location.hostname.includes('localhost') ? 'Development' : 'Production';
            } else {
                document.getElementById('baseUrl').textContent = 'Database manager not loaded';
                document.getElementById('environment').textContent = 'Error';
            }
        });

        function clearConsole() {
            consoleOutput.innerHTML = 'Console cleared...<br>';
        }

        function addResult(elementId, message, success = true) {
            const element = document.getElementById(elementId);
            const alertClass = success ? 'alert-success' : 'alert-danger';
            element.innerHTML = `<div class="alert ${alertClass} mt-2">${message}</div>`;
        }

        function testPassword() {
            const password = document.getElementById('testPassword').value;
            const correct = password === 'BigMountain2024';
            addResult('passwordResult', 
                correct ? '‚úÖ Password correct!' : '‚ùå Password incorrect', 
                correct);
        }

        async function testGetTrips() {
            addResult('functionResults', '‚è≥ Testing get-trips...', true);
            try {
                if (!window.dbManager) {
                    throw new Error('Database manager not initialized');
                }
                const trips = await window.dbManager.getTrips();
                addResult('functionResults', `‚úÖ Got ${trips.length} trips successfully!`, true);
                console.log('Test trips result:', trips);
            } catch (error) {
                addResult('functionResults', `‚ùå get-trips failed: ${error.message}`, false);
                console.error('get-trips test error:', error);
            }
        }

        async function testAddTrip() {
            addResult('functionResults', '‚è≥ Testing add-trip...', true);
            try {
                if (!window.dbManager) {
                    throw new Error('Database manager not initialized');
                }
                
                const testTrip = {
                    location: 'Test Peak',
                    date: '2024-01-01',
                    members: ['Debug User'],
                    description: 'Test trip from debug page',
                    distance: '1 mile',
                    elevation: '100 ft',
                    duration: '1 hour',
                    photos: []
                };
                
                const result = await window.dbManager.addTrip(testTrip);
                addResult('functionResults', `‚úÖ Trip added successfully! ID: ${result.id}`, true);
                console.log('Test trip result:', result);
            } catch (error) {
                addResult('functionResults', `‚ùå add-trip failed: ${error.message}`, false);
                console.error('add-trip test error:', error);
            }
        }

        async function testUploadPhoto() {
            addResult('functionResults', '‚è≥ Testing upload-photos...', true);
            
            // Create a small test image (1x1 pixel PNG)
            const canvas = document.createElement('canvas');
            canvas.width = 1;
            canvas.height = 1;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'red';
            ctx.fillRect(0, 0, 1, 1);
            
            canvas.toBlob(async (blob) => {
                try {
                    if (!window.dbManager) {
                        throw new Error('Database manager not initialized');
                    }
                    
                    const file = new File([blob], 'test-image.png', { type: 'image/png' });
                    const result = await window.dbManager.uploadPhoto(file);
                    
                    if (result) {
                        addResult('functionResults', `‚úÖ Photo uploaded! URL: ${result}`, true);
                        console.log('Test photo result:', result);
                    } else {
                        addResult('functionResults', '‚ùå Photo upload returned null', false);
                    }
                } catch (error) {
                    addResult('functionResults', `‚ùå upload-photos failed: ${error.message}`, false);
                    console.error('upload-photos test error:', error);
                }
            });
        }
    </script>
</body>
</html>