<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Trip Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üîß Add Trip Debug</h2>
        <p>Diagnose why add-trip page doesn't work when test pages do</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="status-info"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Photo Upload Test</h5>
                    </div>
                    <div class="card-body">
                        <input type="file" id="photoFiles" class="form-control mb-2" multiple accept="image/*">
                        <button class="btn btn-primary" onclick="testPhotoUpload()">Test Photo Upload</button>
                        <div id="upload-result" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Script Loading Debug</h5>
                    </div>
                    <div class="card-body">
                        <div id="script-debug"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Logs</h5>
            </div>
            <div class="card-body">
                <pre id="logs" style="background: #f8f9fa; padding: 10px; max-height: 400px; overflow-y: auto; font-size: 12px;"></pre>
            </div>
        </div>
    </div>

    <!-- Load scripts exactly like add-trip.html -->
    <script src="assets/js/github-database.js?v=1"></script>
    <script src="assets/js/add-trip.js?v=6"></script>
    <script>
        const logs = document.getElementById('logs');
        const statusInfo = document.getElementById('status-info');
        const scriptDebug = document.getElementById('script-debug');
        const uploadResult = document.getElementById('upload-result');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(content, type = '') {
            statusInfo.innerHTML = content;
            statusInfo.className = type;
        }
        
        function updateScriptDebug(content) {
            scriptDebug.innerHTML = content;
        }
        
        // Initialize - mimic add-trip.html exactly
        window.addEventListener('load', () => {
            addLog('üîß Add-trip debug starting...');
            
            // Check GitHub token (same as add-trip.html)
            const githubToken = localStorage.getItem('bmc-github-token');
            
            addLog(`GitHub token present: ${!!githubToken}`);
            addLog(`configureAPIs function: ${typeof window.configureAPIs}`);
            addLog(`gitHubDbManager: ${typeof window.gitHubDbManager}`);
            addLog(`dbManager: ${typeof window.dbManager}`);
            
            // Script loading debug
            updateScriptDebug(`
                <div class="mb-2">
                    <strong>GitHub Database Manager:</strong> 
                    <span class="badge ${window.gitHubDbManager ? 'bg-success' : 'bg-danger'}">
                        ${window.gitHubDbManager ? '‚úÖ Loaded' : '‚ùå Missing'}
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Add Trip Class:</strong> 
                    <span class="badge ${window.addTripManager ? 'bg-success' : 'bg-danger'}">
                        ${window.addTripManager ? '‚úÖ Loaded' : '‚ùå Missing'}
                    </span>
                </div>
                <div class="mb-2">
                    <strong>configureAPIs:</strong> 
                    <span class="badge ${window.configureAPIs ? 'bg-success' : 'bg-danger'}">
                        ${window.configureAPIs ? '‚úÖ Available' : '‚ùå Missing'}
                    </span>
                </div>
                <div class="mb-2">
                    <small>gitHubDbManager: ${typeof window.gitHubDbManager}</small><br>
                    <small>dbManager: ${typeof window.dbManager}</small>
                </div>
            `);
            
            if (githubToken && window.configureAPIs) {
                window.configureAPIs(githubToken);
                addLog('‚úÖ GitHub API auto-configured from localStorage');
                
                updateStatus(`
                    <div class="alert alert-success">
                        <h6>‚úÖ GitHub Configured</h6>
                        <small>Token: ${githubToken.substring(0, 8)}...</small>
                    </div>
                `);
            } else {
                addLog('‚ö†Ô∏è GitHub API not configured. Visit setup-apis.html to configure.');
                
                updateStatus(`
                    <div class="alert alert-warning">
                        <h6>‚ö†Ô∏è GitHub Not Configured</h6>
                        <p>Token: ${githubToken ? 'Present' : 'Missing'}</p>
                        <p>configureAPIs: ${window.configureAPIs ? 'Available' : 'Missing'}</p>
                    </div>
                `);
            }
            
            // Also test the database manager reference that add-trip.js would use
            setTimeout(() => {
                const dbMgr = window.gitHubDbManager || window.dbManager;
                addLog(`Database manager reference test: ${!!dbMgr}`);
                if (dbMgr) {
                    addLog(`Upload function available: ${!!dbMgr.uploadPhoto}`);
                    addLog(`Multi-upload function available: ${!!dbMgr.uploadPhotos}`);
                }
            }, 500);
        });
        
        async function testPhotoUpload() {
            const files = document.getElementById('photoFiles').files;
            
            if (files.length === 0) {
                addLog('‚ùå No files selected');
                return;
            }
            
            addLog(`üöÄ Testing photo upload (add-trip style) with ${files.length} files...`);
            
            try {
                // Use the same database manager reference as add-trip.js
                const dbMgr = window.gitHubDbManager || window.dbManager;
                
                if (!dbMgr) {
                    throw new Error('Database manager not available. Please refresh the page and ensure GitHub is configured.');
                }
                
                addLog(`üì§ Using database manager: ${window.gitHubDbManager ? 'gitHubDbManager' : 'dbManager'}`);
                
                // Validate files (same as add-trip.js)
                const validFiles = [];
                for (let file of files) {
                    if (!file.type.startsWith('image/')) {
                        addLog(`‚ö†Ô∏è Skipping ${file.name} - not an image`);
                        continue;
                    }
                    
                    if (file.size > 25 * 1024 * 1024) {
                        addLog(`‚ö†Ô∏è Skipping ${file.name} - too large (${(file.size/1024/1024).toFixed(1)}MB)`);
                        continue;
                    }
                    
                    validFiles.push(file);
                }
                
                if (validFiles.length === 0) {
                    throw new Error('No valid files to upload');
                }
                
                addLog(`‚úÖ ${validFiles.length} valid files to upload`);
                
                // Test uploadPhotos function (as used in add-trip.js)
                const tempTripId = `temp-${Date.now()}`;
                
                const uploadedUrls = await dbMgr.uploadPhotos(validFiles, tempTripId, 
                    (completed, total, success) => {
                        addLog(`Progress: ${completed}/${total} - Last: ${success ? 'SUCCESS' : 'FAILED'}`);
                    }
                );
                
                addLog(`‚úÖ Upload completed: ${uploadedUrls.length}/${validFiles.length} successful`);
                
                uploadResult.innerHTML = `
                    <div class="alert alert-success">
                        <h6>‚úÖ Upload Test Successful!</h6>
                        <p>Uploaded ${uploadedUrls.length}/${validFiles.length} photos</p>
                        ${uploadedUrls.length > 0 ? '<small>URLs: ' + uploadedUrls.map(u => u.split('/').pop()).join(', ') + '</small>' : ''}
                    </div>
                `;
                
            } catch (error) {
                addLog(`‚ùå Upload failed: ${error.message}`);
                
                uploadResult.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Upload Test Failed</h6>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>