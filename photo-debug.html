<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Upload Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üì∏ Photo Upload Debug</h2>
        <p>Direct test of photo upload functionality</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Photo Upload Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="debugPhotoFiles" class="form-label">Select Photos:</label>
                            <input type="file" class="form-control" id="debugPhotoFiles" multiple accept="image/*">
                            <small class="text-muted">Select 1-3 images to test upload</small>
                        </div>
                        
                        <button class="btn btn-primary" onclick="testDirectUpload()">
                            üöÄ Test Direct Upload
                        </button>
                        
                        <div id="progress-area" class="mt-3"></div>
                        <div id="result-area" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Debug Info</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-info">
                            <div class="text-muted">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Upload Logs</h5>
            </div>
            <div class="card-body">
                <pre id="logs" style="background: #f8f9fa; padding: 10px; max-height: 400px; overflow-y: auto; font-size: 12px;"></pre>
            </div>
        </div>
    </div>

    <script src="assets/js/github-database.js"></script>
    <script>
        const debugInfo = document.getElementById('debug-info');
        const logs = document.getElementById('logs');
        const progressArea = document.getElementById('progress-area');
        const resultArea = document.getElementById('result-area');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateDebugInfo(info) {
            debugInfo.innerHTML = info;
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            addLog('üîß Starting photo upload debug...');
            
            // Check system status
            const githubToken = localStorage.getItem('bmc-github-token');
            const hasToken = !!githubToken;
            
            let dbManagerStatus = 'Not Available';
            let dbMgr = null;
            
            if (window.gitHubDbManager) {
                dbManagerStatus = 'gitHubDbManager Available';
                dbMgr = window.gitHubDbManager;
            } else if (window.dbManager) {
                dbManagerStatus = 'dbManager Available';
                dbMgr = window.dbManager;
            }
            
            // Configure if token exists
            if (hasToken && window.configureAPIs) {
                window.configureAPIs(githubToken);
                addLog('‚úÖ APIs configured with saved token');
            }
            
            updateDebugInfo(`
                <div class="mb-2">
                    <strong>GitHub Token:</strong> 
                    <span class="badge ${hasToken ? 'bg-success' : 'bg-danger'}">
                        ${hasToken ? '‚úÖ Present' : '‚ùå Missing'}
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Database Manager:</strong> 
                    <span class="badge ${dbMgr ? 'bg-success' : 'bg-danger'}">
                        ${dbManagerStatus}
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Upload Function:</strong> 
                    <span class="badge ${dbMgr && dbMgr.uploadPhoto ? 'bg-success' : 'bg-danger'}">
                        ${dbMgr && dbMgr.uploadPhoto ? '‚úÖ Available' : '‚ùå Missing'}
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Multi Upload Function:</strong> 
                    <span class="badge ${dbMgr && dbMgr.uploadPhotos ? 'bg-success' : 'bg-danger'}">
                        ${dbMgr && dbMgr.uploadPhotos ? '‚úÖ Available' : '‚ùå Missing'}
                    </span>
                </div>
            `);
            
            addLog(`Token present: ${hasToken}`);
            addLog(`DB Manager: ${dbManagerStatus}`);
            addLog(`Upload functions: ${dbMgr && dbMgr.uploadPhoto ? 'YES' : 'NO'}`);
        });
        
        async function testDirectUpload() {
            const files = document.getElementById('debugPhotoFiles').files;
            
            if (files.length === 0) {
                addLog('‚ùå No files selected');
                return;
            }
            
            addLog(`üöÄ Starting upload test with ${files.length} files...`);
            
            // Show progress
            progressArea.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <div>
                            <strong>Uploading ${files.length} photo(s)...</strong><br>
                            <span id="progress-text">Starting...</span>
                        </div>
                    </div>
                    <div class="progress mt-2">
                        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            try {
                const dbMgr = window.gitHubDbManager || window.dbManager;
                if (!dbMgr) {
                    throw new Error('Database manager not available');
                }
                
                addLog('üì§ Using database manager: ' + (window.gitHubDbManager ? 'gitHubDbManager' : 'dbManager'));
                
                // Test individual upload function first
                const testFile = files[0];
                addLog(`üß™ Testing single upload with: ${testFile.name} (${(testFile.size/1024/1024).toFixed(2)}MB)`);
                
                const singleUrl = await dbMgr.uploadPhoto(testFile, 'debug-test');
                
                if (singleUrl) {
                    addLog(`‚úÖ Single upload successful: ${singleUrl}`);
                    
                    // Now test multi-upload if available
                    if (dbMgr.uploadPhotos && files.length > 1) {
                        addLog('üöÄ Testing multi-upload...');
                        
                        const allFiles = Array.from(files);
                        const uploadedUrls = await dbMgr.uploadPhotos(allFiles, 'debug-batch', 
                            (completed, total, success) => {
                                const progressText = document.getElementById('progress-text');
                                const progressBar = document.getElementById('progress-bar');
                                
                                if (progressText) progressText.textContent = `${completed} of ${total} uploaded`;
                                if (progressBar) progressBar.style.width = `${(completed/total)*100}%`;
                                
                                addLog(`Progress: ${completed}/${total} - Last: ${success ? 'SUCCESS' : 'FAILED'}`);
                            }
                        );
                        
                        addLog(`‚úÖ Multi-upload completed: ${uploadedUrls.length}/${files.length} successful`);
                        
                        // Show results
                        let resultHtml = `
                            <div class="alert alert-success">
                                <h6>‚úÖ Upload Test Completed!</h6>
                                <p><strong>Single Upload:</strong> ‚úÖ Success</p>
                                <p><strong>Multi Upload:</strong> ${uploadedUrls.length}/${files.length} successful</p>
                            </div>
                            <div class="row">
                        `;
                        
                        [singleUrl, ...uploadedUrls].forEach((url, index) => {
                            if (url) {
                                resultHtml += `
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <img src="${url}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                            <div class="card-body p-2">
                                                <small class="text-muted">${url.split('/').pop()}</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        resultHtml += '</div>';
                        resultArea.innerHTML = resultHtml;
                        
                    } else {
                        // Just single upload result
                        resultArea.innerHTML = `
                            <div class="alert alert-success">
                                <h6>‚úÖ Single Upload Successful!</h6>
                                <div class="mt-2">
                                    <img src="${singleUrl}" class="img-thumbnail" style="max-width: 200px;">
                                </div>
                                <p class="mt-2"><small>${singleUrl}</small></p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Single upload returned null');
                }
                
            } catch (error) {
                addLog(`‚ùå Upload test failed: ${error.message}`);
                addLog(`üìã Stack trace: ${error.stack}`);
                
                resultArea.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Upload Test Failed</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p class="text-muted">Check the logs for more details</p>
                    </div>
                `;
            } finally {
                // Clear progress
                progressArea.innerHTML = '';
            }
        }
    </script>
</body>
</html>