<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Storage Diagnostics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container my-4">
        <h1>Firebase Storage Diagnostics</h1>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5>1. Connection Test</h5>
            </div>
            <div class="card-body">
                <button onclick="testConnection()" class="btn btn-primary">Test Connection</button>
                <div id="connection-result" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5>2. Upload Permission Test</h5>
            </div>
            <div class="card-body">
                <p>This will try to create a small test file to verify your Firebase Storage rules:</p>
                <button onclick="testUploadPermissions()" class="btn btn-warning">Test Upload Rules</button>
                <div id="upload-test-result" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5>3. Actual Photo Upload Test</h5>
            </div>
            <div class="card-body">
                <input type="file" id="testPhoto" accept="image/*" class="form-control mb-3">
                <button onclick="testPhotoUpload()" class="btn btn-success">Upload Test Photo</button>
                <div id="photo-test-result" class="mt-3"></div>
                <div id="uploaded-photo-display" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js?v=4"></script>
    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            element.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }

        function testConnection() {
            try {
                if (typeof firebase === 'undefined') {
                    log('connection-result', '‚ùå Firebase SDK not loaded', 'error');
                    return;
                }

                if (!firebase.apps.length) {
                    log('connection-result', '‚ùå Firebase app not initialized', 'error');
                    return;
                }

                const storage = firebase.storage();
                if (!storage) {
                    log('connection-result', '‚ùå Firebase Storage not available', 'error');
                    return;
                }

                const app = firebase.app();
                const config = app.options;
                
                log('connection-result', `
                    ‚úÖ Firebase connection successful!<br>
                    <strong>Project ID:</strong> ${config.projectId}<br>
                    <strong>Storage Bucket:</strong> ${config.storageBucket}<br>
                    <strong>App Name:</strong> ${app.name}
                `, 'success');

            } catch (error) {
                log('connection-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        async function testUploadPermissions() {
            log('upload-test-result', 'üîÑ Testing upload permissions with a tiny test image...', 'info');
            
            try {
                const storage = firebase.storage();
                
                // Create a tiny 1x1 pixel PNG image (base64 encoded)
                const tinyPngBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                const binaryString = atob(tinyPngBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const testFile = new Blob([bytes], { type: 'image/png' });
                
                // Try to upload to trip-photos folder
                const testPath = `trip-photos/test-${Date.now()}/test-permission.png`;
                const storageRef = storage.ref(testPath);
                
                await storageRef.put(testFile);
                
                // If we get here, upload worked - now delete the test file
                await storageRef.delete();
                
                log('upload-test-result', '‚úÖ Upload permissions working correctly!', 'success');
                
            } catch (error) {
                console.error('Upload permission test error:', error);
                
                let errorMessage = `‚ùå Upload permission test failed: ${error.message}`;
                
                if (error.code === 'storage/unauthorized') {
                    errorMessage += '<br><br><strong>Solution:</strong> Your Firebase Storage rules are blocking uploads.<br><br><strong>Try this:</strong><br>1. Go to Firebase Console ‚Üí Storage ‚Üí Rules<br>2. Click "Publish" button (make sure rules are deployed)<br>3. Or use the simpler rules provided above<br>4. Wait for "Rules published successfully" message';
                } else if (error.code === 'storage/unknown') {
                    errorMessage += '<br><br><strong>Possible causes:</strong><br>1. Storage bucket not properly configured<br>2. Rules not deployed<br>3. Network connectivity issues';
                }
                
                log('upload-test-result', errorMessage, 'error');
            }
        }

        async function testPhotoUpload() {
            const fileInput = document.getElementById('testPhoto');
            const file = fileInput.files[0];
            
            if (!file) {
                log('photo-test-result', '‚ö†Ô∏è Please select a photo first', 'warning');
                return;
            }

            if (!file.type.startsWith('image/')) {
                log('photo-test-result', '‚ùå Please select an image file', 'error');
                return;
            }

            log('photo-test-result', 'üîÑ Uploading photo...', 'info');
            
            try {
                const storage = firebase.storage();
                const timestamp = Date.now();
                const fileName = `test-${timestamp}-${file.name}`;
                const photoPath = `trip-photos/diagnostic-test/${fileName}`;
                
                const storageRef = storage.ref(photoPath);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                log('photo-test-result', `‚úÖ Photo uploaded successfully!<br><strong>URL:</strong> <a href="${downloadURL}" target="_blank">View Photo</a>`, 'success');
                
                // Display the uploaded photo
                document.getElementById('uploaded-photo-display').innerHTML = `
                    <div class="text-center">
                        <h6>Uploaded Photo:</h6>
                        <img src="${downloadURL}" style="max-width: 300px; max-height: 300px;" class="border rounded">
                    </div>
                `;
                
            } catch (error) {
                console.error('Photo upload error:', error);
                
                let errorMessage = `‚ùå Photo upload failed: ${error.message}`;
                
                if (error.code === 'storage/unauthorized') {
                    errorMessage += '<br><br><strong>Fix:</strong> Your Storage rules are blocking image uploads. Check that your rules are published and allow image uploads to trip-photos folder.';
                }
                
                log('photo-test-result', errorMessage, 'error');
            }
        }

        // Auto-test connection on page load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>