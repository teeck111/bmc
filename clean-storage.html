<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Storage - BMC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; }
        .danger { background: #dc3545; color: white; border: none; }
        .success { background: #28a745; color: white; border: none; }
    </style>
</head>
<body>
    <h1>Storage Cleanup Tool</h1>
    
    <div class="alert alert-warning">
        <strong>⚠️ Important:</strong> This tool helps clean up large photo data that might be causing Firebase errors.
        It will remove base64-encoded images from your trips but keep photo URLs intact.
    </div>
    
    <div id="status"></div>
    
    <button class="success" onclick="analyzeStorage()">Analyze Storage</button>
    <button class="danger" onclick="cleanStorage()">Clean Large Data</button>
    <button onclick="viewTrips()">View Current Trips</button>
    
    <div id="results" style="margin-top: 20px;"></div>
    
    <script>
        function analyzeStorage() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                const stored = localStorage.getItem('bmcTrips');
                
                if (!stored) {
                    statusDiv.innerHTML = '<div class="alert alert-warning">No trips found in localStorage</div>';
                    return;
                }
                
                const trips = JSON.parse(stored);
                let totalSize = stored.length;
                let largePhotoCount = 0;
                let base64PhotoCount = 0;
                
                const analysis = trips.map((trip, index) => {
                    let tripIssues = [];
                    
                    if (trip.photos) {
                        trip.photos.forEach((photo, photoIndex) => {
                            if (typeof photo === 'string') {
                                if (photo.startsWith('data:')) {
                                    base64PhotoCount++;
                                    tripIssues.push(`Photo ${photoIndex + 1}: Base64 data (${(photo.length/1024).toFixed(1)}KB)`);
                                } else if (photo.length > 500) {
                                    largePhotoCount++;
                                    tripIssues.push(`Photo ${photoIndex + 1}: Very long URL (${photo.length} chars)`);
                                }
                            }
                        });
                    }
                    
                    return {
                        trip: trip.location || `Trip ${index + 1}`,
                        issues: tripIssues
                    };
                });
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Analysis Complete:</strong><br>
                        • Total trips: ${trips.length}<br>
                        • Total storage size: ${(totalSize/1024).toFixed(1)}KB<br>
                        • Base64 photos found: ${base64PhotoCount}<br>
                        • Large URLs found: ${largePhotoCount}
                    </div>
                `;
                
                const issueList = analysis
                    .filter(item => item.issues.length > 0)
                    .map(item => `<li><strong>${item.trip}:</strong><ul>${item.issues.map(issue => `<li>${issue}</li>`).join('')}</ul></li>`)
                    .join('');
                    
                resultsDiv.innerHTML = issueList ? `<h3>Issues Found:</h3><ul>${issueList}</ul>` : '<p class="alert alert-success">No storage issues found!</p>';
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error analyzing storage: ${error.message}</div>`;
            }
        }
        
        function cleanStorage() {
            if (!confirm('This will remove base64 image data from your trips. Photo URLs will be kept. Continue?')) {
                return;
            }
            
            const statusDiv = document.getElementById('status');
            
            try {
                const stored = localStorage.getItem('bmcTrips');
                
                if (!stored) {
                    statusDiv.innerHTML = '<div class="alert alert-warning">No trips found in localStorage</div>';
                    return;
                }
                
                const trips = JSON.parse(stored);
                let removedCount = 0;
                
                const cleanedTrips = trips.map(trip => {
                    const cleanedTrip = { ...trip };
                    
                    if (cleanedTrip.photos && Array.isArray(cleanedTrip.photos)) {
                        const originalCount = cleanedTrip.photos.length;
                        cleanedTrip.photos = cleanedTrip.photos.filter(photo => {
                            if (typeof photo === 'string') {
                                // Remove base64 data URLs
                                if (photo.startsWith('data:')) {
                                    removedCount++;
                                    return false;
                                }
                                // Remove very long URLs
                                if (photo.length > 500) {
                                    removedCount++;
                                    return false;
                                }
                                return true;
                            }
                            return false;
                        });
                    }
                    
                    return cleanedTrip;
                });
                
                localStorage.setItem('bmcTrips', JSON.stringify(cleanedTrips));
                
                const newSize = localStorage.getItem('bmcTrips').length;
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Cleanup Complete!</strong><br>
                        • Removed ${removedCount} large/base64 photos<br>
                        • New storage size: ${(newSize/1024).toFixed(1)}KB<br>
                        • You can now try editing trips again
                    </div>
                `;
                
                setTimeout(() => {
                    analyzeStorage(); // Re-analyze to show results
                }, 1000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error cleaning storage: ${error.message}</div>`;
            }
        }
        
        function viewTrips() {
            const resultsDiv = document.getElementById('results');
            
            try {
                const stored = localStorage.getItem('bmcTrips');
                
                if (!stored) {
                    resultsDiv.innerHTML = '<p class="alert alert-warning">No trips found in localStorage</p>';
                    return;
                }
                
                const trips = JSON.parse(stored);
                
                const tripsList = trips.map((trip, index) => {
                    const photoCount = trip.photos ? trip.photos.length : 0;
                    return `
                        <li>
                            <strong>${trip.location || `Trip ${index + 1}`}</strong>
                            (${trip.date || 'No date'}) - ${photoCount} photos
                        </li>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = `<h3>Current Trips (${trips.length}):</h3><ul>${tripsList}</ul>`;
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="alert alert-danger">Error loading trips: ${error.message}</p>`;
            }
        }
        
        // Auto-analyze on load
        setTimeout(analyzeStorage, 500);
    </script>
</body>
</html>